<!-- templates/accounts/users_management.html -->
{% extends 'base.html' %}

{% block title %}Gestion des Utilisateurs - Restaurant Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-users-cog"></i> Gestion des Utilisateurs</h2>
    <div>
        <a href="{% url 'accounts:register' %}" class="btn btn-success">
            <i class="fas fa-user-plus"></i> Nouvel utilisateur
        </a>
        <a href="{% url 'dashboard:dashboard' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Retour au dashboard
        </a>
    </div>
</div>

<!-- Statistiques -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-primary">{{ users.count }}</h4>
                <small class="text-muted">Utilisateurs total</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-success">{{ users|length }}</h4>
                <small class="text-muted">Comptes actifs</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-warning">{{ groups.count }}</h4>
                <small class="text-muted">Groupes définis</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-info">1</h4>
                <small class="text-muted">Administrateur</small>
            </div>
        </div>
    </div>
</div>

<!-- Liste des utilisateurs -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-list"></i> Liste des utilisateurs</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Utilisateur</th>
                        <th>Email</th>
                        <th>Rôle</th>
                        <th>Statut</th>
                        <th>Dernière connexion</th>
                        <th>Inscrit le</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr id="user-row-{{ user.id }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar me-2">
                                    {% if user.is_superuser %}
                                        <i class="fas fa-crown text-warning"></i>
                                    {% elif user.groups.filter %}
                                        <i class="fas fa-user-tie text-info"></i>
                                    {% else %}
                                        <i class="fas fa-user text-muted"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <strong>{{ user.get_full_name|default:user.username }}</strong>
                                    {% if user.username != user.get_full_name and user.get_full_name %}
                                        <br><small class="text-muted">{{ user.username }}</small>
                                    {% endif %}
                                    {% if user == request.user %}
                                        <span class="badge bg-primary ms-2">Vous</span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if user.email %}
                                <a href="mailto:{{ user.email }}">{{ user.email }}</a>
                            {% else %}
                                <span class="text-muted">Non renseigné</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_superuser %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-crown"></i> Admin
                                </span>
                            {% elif user.groups.filter.name == 'Managers' %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-user-tie"></i> Manager
                                </span>
                            {% elif user.groups.filter.name == 'Employees' %}
                                <span class="badge bg-info">
                                    <i class="fas fa-user"></i> Employé
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-user-circle"></i> Utilisateur
                                </span>
                            {% endif %}
                            
                            {% if user != request.user and not user.is_superuser %}
                            <div class="mt-1">
                                <select class="form-select form-select-sm" onchange="changeUserGroup({{ user.id }}, this.value)">
                                    <option value="">Changer le rôle</option>
                                    <option value="none">Aucun groupe</option>
                                    {% for group in groups %}
                                    <option value="{{ group.name }}" 
                                        {% if user.groups.filter.name == group.name %}selected{% endif %}>
                                        {{ group.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if user.is_active %}
                                    <span class="badge bg-success">Actif</span>
                                {% else %}
                                    <span class="badge bg-danger">Inactif</span>
                                {% endif %}
                                
                                {% if user != request.user %}
                                <div class="form-check form-switch ms-2">
                                    <input class="form-check-input" type="checkbox" 
                                           {% if user.is_active %}checked{% endif %}
                                           onchange="toggleUserStatus({{ user.id }})"
                                           id="status-{{ user.id }}">
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            {% if user.last_login %}
                                <span title="{{ user.last_login|date:'d/m/Y H:i:s' }}">
                                    {{ user.last_login|timesince }} ago
                                </span>
                            {% else %}
                                <span class="text-muted">Jamais</span>
                            {% endif %}
                        </td>
                        <td>
                            <span title="{{ user.date_joined|date:'d/m/Y H:i:s' }}">
                                {{ user.date_joined|date:'d/m/Y' }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if user.email %}
                                <a href="mailto:{{ user.email }}" class="btn btn-outline-primary" title="Envoyer un email">
                                    <i class="fas fa-envelope"></i>
                                </a>
                                {% endif %}
                                
                                {% if user != request.user %}
                                <button class="btn btn-outline-info" onclick="viewUserDetails({{ user.id }})" title="Voir détails">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Groupes et permissions -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-users"></i> Groupes disponibles</h6>
            </div>
            <div class="card-body">
                {% for group in groups %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span><strong>{{ group.name }}</strong></span>
                    <span class="badge bg-secondary">{{ group.user_set.count }} utilisateur{{ group.user_set.count|pluralize }}</span>
                </div>
                {% empty %}
                <p class="text-muted">Aucun groupe configuré</p>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-shield-alt"></i> Permissions par rôle</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong class="text-danger">Administrateur :</strong>
                    <ul class="small mb-0">
                        <li>Accès complet à tous les modules</li>
                        <li>Gestion des utilisateurs</li>
                        <li>Administration système</li>
                    </ul>
                </div>
                <div class="mb-3">
                    <strong class="text-warning">Manager :</strong>
                    <ul class="small mb-0">
                        <li>Finances (lecture/écriture + import Excel)</li>
                        <li>Devis et clients (complet)</li>
                        <li>Recettes (complet)</li>
                    </ul>
                </div>
                <div class="mb-3">
                    <strong class="text-info">Employé :</strong>
                    <ul class="small mb-0">
                        <li>Finances (lecture/écriture uniquement)</li>
                        <li>Pas d'accès aux devis et recettes</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleUserStatus(userId) {
    fetch(`/accounts/users/${userId}/toggle-status/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mettre à jour l'affichage
            const row = document.getElementById(`user-row-${userId}`);
            const statusBadge = row.querySelector('.badge');
            
            if (data.is_active) {
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'Actif';
            } else {
                statusBadge.className = 'badge bg-danger';
                statusBadge.textContent = 'Inactif';
            }
            
            // Afficher le message
            showMessage(data.message, 'success');
        } else {
            showMessage(data.message, 'error');
            // Revenir à l'état précédent
            document.getElementById(`status-${userId}`).checked = !document.getElementById(`status-${userId}`).checked;
        }
    })
    .catch(error => {
        showMessage('Erreur lors de la modification du statut', 'error');
        console.error('Error:', error);
    });
}

function changeUserGroup(userId, groupName) {
    const formData = new FormData();
    formData.append('group', groupName);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/accounts/users/${userId}/change-group/`, {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Recharger la page pour mettre à jour l'affichage
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Erreur lors de la modification du groupe', 'error');
        console.error('Error:', error);
    });
}

function showMessage(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insérer l'alerte en haut de la page
    const container = document.querySelector('.container');
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Supprimer automatiquement après 5 secondes
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

function viewUserDetails(userId) {
    // Cette fonction pourrait ouvrir une modal avec plus de détails
    console.log('Voir détails utilisateur', userId);
}
</script>

<!-- Token CSRF pour les requêtes AJAX -->
{% csrf_token %}
{% endblock %}